// MALWARE SCANNER - DETECCI√ìN Y BLOQUEO DE PHEDRA AI
// =====================================================

console.log('üõ°Ô∏è Iniciando scanner de malware PHEDRA AI...');

class MalwareScanner {
    constructor() {
        this.scanInterval = null;
        this.blockedDomains = ['phedra.ai', 'phedra-ai.com', 'ai-phedra.com', 'phedra-ia.com', 'ia-phedra.com'];
        this.blockedPatterns = ['phedra', 'PHEDRA', 'Phedra', 'phedra ia', 'PHEDRA IA', 'Phedra IA', 'phedra ai', 'PHEDRA AI', 'Phedra AI'];
    }

    start() {
        console.log('üîç Scanner activado - Monitoreando PHEDRA AI...');

        // Escanear inmediatamente
        this.scan();

        // Escanear cada 1 segundo (m√°s frecuente para mejor protecci√≥n)
        this.scanInterval = setInterval(() => {
            this.scan();
        }, 1000);

        // Escanear cuando se carga el DOM completamente
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => this.scan());
        } else {
            this.scan();
        }

        // Escanear cuando se a√±aden nuevos elementos
        this.observeChanges();
    }

    scan() {
        this.detectAndBlockBanners();
        this.detectAndBlockScripts();
        this.detectAndBlockStyles();
        this.detectAndBlockIframes();
        this.detectAndBlockNetworkRequests();
        this.detectSuspiciousAttributes();
    }

    detectAndBlockBanners() {
        // Buscar banners por patrones comunes
        const suspiciousSelectors = [
            '[class*="phedra"]',
            '[id*="phedra"]',
            '[class*="banner"]',
            '[id*="banner"]',
            'div[style*="position: fixed"]',
            'div[style*="position: absolute"]',
            '[style*="z-index: 9999"]',
            '[style*="z-index: 99999"]'
        ];

        suspiciousSelectors.forEach(selector => {
            const elements = document.querySelectorAll(selector);
            elements.forEach(element => {
                if (this.isPhedraElement(element)) {
                    this.blockElement(element, 'banner PHEDRA AI detectado');
                }
            });
        });

        // Buscar texto espec√≠fico
        const allElements = document.querySelectorAll('*');
        allElements.forEach(element => {
            if (element.textContent && this.blockedPatterns.some(pattern =>
                element.textContent.toLowerCase().includes(pattern.toLowerCase())
            )) {
                this.blockElement(element, 'texto PHEDRA AI detectado');
            }
        });
    }

    detectAndBlockScripts() {
        const scripts = document.querySelectorAll('script[src], script:not([src])');
        scripts.forEach(script => {
            const src = script.src ? script.src.toLowerCase() : '';
            const innerHTML = script.innerHTML ? script.innerHTML.toLowerCase() : '';

            if (src && this.blockedPatterns.some(pattern => src.includes(pattern.toLowerCase()))) {
                this.blockElement(script, 'script PHEDRA AI detectado por src');
                script.remove();
                return;
            }

            if (innerHTML && this.blockedPatterns.some(pattern => innerHTML.includes(pattern.toLowerCase()))) {
                this.blockElement(script, 'script PHEDRA AI detectado por contenido');
                script.remove();
                return;
            }
        });
    }

    detectAndBlockStyles() {
        const links = document.querySelectorAll('link[href]');
        links.forEach(link => {
            const href = link.href.toLowerCase();
            if (this.blockedPatterns.some(pattern => href.includes(pattern.toLowerCase()))) {
                this.blockElement(link, 'CSS PHEDRA AI detectado');
                link.remove();
            }
        });
    }

    detectAndBlockIframes() {
        const iframes = document.querySelectorAll('iframe');
        iframes.forEach(iframe => {
            const src = iframe.src?.toLowerCase() || '';
            if (this.blockedPatterns.some(pattern => src.includes(pattern.toLowerCase()))) {
                this.blockElement(iframe, 'iframe PHEDRA AI detectado');
                iframe.remove();
            }
        });
    }

    detectSuspiciousAttributes() {
        const allElements = document.querySelectorAll('*');
        allElements.forEach(element => {
            Array.from(element.attributes).forEach(attr => {
                const attrValue = attr.value.toLowerCase();
                if (this.blockedPatterns.some(pattern => attrValue.includes(pattern.toLowerCase()))) {
                    this.blockElement(element, `atributo sospechoso: ${attr.name}="${attr.value}"`);
                }
            });
        });
    }

    detectAndBlockNetworkRequests() {
        const originalFetch = window.fetch;
        window.fetch = function(...args) {
            const url = args[0]?.toString().toLowerCase() || '';
            if (window.malwareScanner.blockedPatterns.some(pattern =>
                url.includes(pattern.toLowerCase())
            )) {
                console.warn('üö´ Petici√≥n PHEDRA AI bloqueada:', args[0]);
                return Promise.reject(new Error('Petici√≥n bloqueada por seguridad'));
            }
            return originalFetch.apply(this, args);
        };

        const originalXHR = window.XMLHttpRequest;
        const originalOpen = originalXHR.prototype.open;
        originalXHR.prototype.open = function(method, url, ...args) {
            const lowerUrl = url.toString().toLowerCase();
            if (window.malwareScanner.blockedPatterns.some(pattern =>
                lowerUrl.includes(pattern.toLowerCase())
            )) {
                console.warn('üö´ XMLHttpRequest PHEDRA AI bloqueado:', url);
                throw new Error('XMLHttpRequest bloqueado por seguridad');
            }
            return originalOpen.apply(this, [method, url, ...args]);
        };
    }

    isPhedraElement(element) {
        const elementText = (element.textContent || '').toLowerCase();
        const elementClass = (element.className || '').toLowerCase();
        const elementId = (element.id || '').toLowerCase();
        const elementStyle = (element.getAttribute('style') || '').toLowerCase();

        return this.blockedPatterns.some(pattern => {
            const lowerPattern = pattern.toLowerCase();
            return elementText.includes(lowerPattern) ||
                   elementClass.includes(lowerPattern) ||
                   elementId.includes(lowerPattern) ||
                   elementStyle.includes(lowerPattern);
        });
    }

    blockElement(element, reason) {
        if (!element || element.dataset?.malwareBlocked === 'true') return;

        console.warn('üö´ Elemento bloqueado:', reason, element);
        element.dataset.malwareBlocked = 'true';

        const blockMethods = [
            () => element.remove(),
            () => element.style.display = 'none',
            () => element.style.visibility = 'hidden',
            () => element.outerHTML = '<!-- PHEDRA AI BLOCKED -->'
        ];

        blockMethods.forEach(method => {
            try {
                method(element);
                console.log('‚úÖ Elemento PHEDRA AI eliminado con √©xito');
            } catch (error) {
                console.warn('‚ùå Error al bloquear elemento:', error);
            }
        });

        this.notifyUser(reason);
    }

    notifyUser(reason) {
        const notification = document.createElement('div');
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: #d32f2f;
            color: white;
            padding: 15px 20px;
            border-radius: 5px;
            z-index: 100000;
            font-family: Arial, sans-serif;
            font-size: 14px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        `;
        notification.innerHTML = `
            <div style="display: flex; align-items: center; gap: 10px;">
                <span style="font-size: 18px;">üõ°Ô∏è</span>
                <div>
                    <strong>Protecci√≥n Activada</strong><br>
                    <small>${reason}</small>
                </div>
                <button onclick="this.parentElement.parentElement.remove()"
                        style="background: none; border: none; color: white; font-size: 18px; cursor: pointer; margin-left: 10px;">√ó</button>
            </div>
        `;

        document.body.appendChild(notification);
        setTimeout(() => {
            if (notification.parentNode) {
                notification.remove();
            }
        }, 5000);
    }

    observeChanges() {
        const observer = new MutationObserver((mutations) => {
            mutations.forEach(mutation => {
                if (mutation.type === 'childList') {
                    mutation.addedNodes.forEach(node => {
                        if (node.nodeType === Node.ELEMENT_NODE) {
                            if (this.isPhedraElement(node)) {
                                this.blockElement(node, 'elemento PHEDRA AI detectado din√°micamente');
                            }
                        }
                    });
                }
            });
        });

        observer.observe(document.body, {
            childList: true,
            subtree: true
        });
    }

    stop() {
        if (this.scanInterval) {
            clearInterval(this.scanInterval);
            this.scanInterval = null;
        }
        console.log('‚èπÔ∏è Scanner detenido');
    }
}

// Iniciar scanner autom√°ticamente
window.malwareScanner = new MalwareScanner();
window.malwareScanner.start();

console.log('‚úÖ Malware scanner PHEDRA AI iniciado y monitoreando...');